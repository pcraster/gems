

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Overview &mdash; GEMS 0.1 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="GEMS 0.1 documentation" href="index.html"/>
        <link rel="next" title="GEMS Web Application" href="webapplication.html"/>
        <link rel="prev" title="Installation" href="install.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> GEMS
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="prerequisites.html">Prerequisites</a></li>
<li class="toctree-l1"><a class="reference internal" href="install.html">Installation</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="">Overview</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#database">Database</a></li>
<li class="toctree-l2"><a class="reference internal" href="#message-queue">Message Queue</a></li>
<li class="toctree-l2"><a class="reference internal" href="#data-model">Data Model</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#discretization">Discretization</a></li>
<li class="toctree-l3"><a class="reference internal" href="#chunk">Chunk</a></li>
<li class="toctree-l3"><a class="reference internal" href="#map">Map</a></li>
<li class="toctree-l3"><a class="reference internal" href="#model">Model</a></li>
<li class="toctree-l3"><a class="reference internal" href="#modelconfiguration">ModelConfiguration</a></li>
<li class="toctree-l3"><a class="reference internal" href="#job">Job</a></li>
<li class="toctree-l3"><a class="reference internal" href="#jobchunk">JobChunk</a></li>
<li class="toctree-l3"><a class="reference internal" href="#user">User</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#gems-web-application">GEMS Web Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="#gems-modeller">GEMS Modeller</a></li>
<li class="toctree-l2"><a class="reference internal" href="#gems-processing">GEMS Processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="#an-example-model-run">An Example Model Run</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="webapplication.html">GEMS Web Application</a></li>
<li class="toctree-l1"><a class="reference internal" href="webclient.html">GEMS Modeller</a></li>
<li class="toctree-l1"><a class="reference internal" href="processing.html">GEMS Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="development.html">Developers Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="modelling.html">Building Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="vision.html">Vision</a></li>
<li class="toctree-l1"><a class="reference internal" href="faqs.html">Frequently Asked Questions</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">GEMS</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
    <li>Overview</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/overview.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="overview">
<h1>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h1>
<p>This chapter contains a birds-eye view of the GEMS application. It is intended to give a tech-savvy user a basic understanding of how the system and the different components work. You can refer to the chapters on the web application, modeller and processing for more detailed information.</p>
<p>The application consists of three main parts:</p>
<ul class="simple">
<li>The web client (GEMS modeller)</li>
<li>The web application (GEMS web application)</li>
<li>The processing backend (GEMS processor)</li>
</ul>
<p>The web client is generally referred to as the GEMS modeller, and consists of the JavaScript application that communicates with the API to post processing jobs.</p>
<p>The web application encompasses various other components: the server-side Python application (API, admin interface, etc), UMN mapserver, the beanstalkd work queue, and a Postgresql/PostGIS database.</p>
<p>The processing backend is a script which monitors the work queue, reserving and processing jobs as they become available. After processing is completed, the resulting maps are posted back to the API so that the web client can load them in the mapping interface.</p>
<img alt="_images/architecture.png" src="_images/architecture.png" />
<div class="section" id="database">
<h2>Database<a class="headerlink" href="#database" title="Permalink to this headline">¶</a></h2>
<p>The data model in the GEMS application is defined in the <code class="docutils literal"><span class="pre">~/webapp/models.py</span></code> file. GEMS uses the <a class="reference external" href="http://www.sqlalchemy.org/">SQLAlchemy</a> library to define the data model using Python classes. SQLAlchemy maps the object classes to database tables, and the object&#8217;s properties to fields/columns in the respective table. This means that we don&#8217;t have to write our own SQL queries or create the appropriate tables ourselves, but rather we can load and modify Python objects via SQLAlchemy. Changes to these objects can then be commited back to the database, and we can use the objects properties to display information about them in templates or other parts of the application. GEMS uses a PostgreSQL database with the PostGIS extension. To be able to use spatial queries (i.e. the PostGIS funcationality) in SQLAlchemy, the <a class="reference external" href="https://geoalchemy-2.readthedocs.org/">GeoAlchemy2</a> package is used.</p>
</div>
<div class="section" id="message-queue">
<h2>Message Queue<a class="headerlink" href="#message-queue" title="Permalink to this headline">¶</a></h2>
<p>The message queue (also known as work queue, or job queue) uses <a class="reference external" href="http://kr.github.io/beanstalkd/">beanstalkd</a>, a simple and fast work queue written in C. Beanstalkd uses a concept of &#8216;tubes&#8217; in which jobs can be placed. Other scripts (workers) can then monitor a tube and a receive jobs from them. Any jobs which are scheduled within the GEMS application are placed in the <code class="docutils literal"><span class="pre">gemsjobs</span></code> tube and processed by workers which are connected to beanstalkd and are watching the <code class="docutils literal"><span class="pre">gemsjobs</span></code> tube. Jobs are posted to the beanstalk queue as pickled strings.</p>
</div>
<div class="section" id="data-model">
<h2>Data Model<a class="headerlink" href="#data-model" title="Permalink to this headline">¶</a></h2>
<p>The data model maps and stores certain concepts to database tables and python objects. They are explained briefly here, and in more detail in the <a class="reference internal" href="#gems-web-application">GEMS Web Application</a> chapter.</p>
<div class="section" id="discretization">
<h3>Discretization<a class="headerlink" href="#discretization" title="Permalink to this headline">¶</a></h3>
<p>A <strong>discretization</strong> is also known as a chunkscheme, a naming convention left over from the old GEMS application. The GEMS application needs to divide the world up into smaller managable sections so that the geographical extent of the model run can be constrained. After all, running a model on a grid with millions of rows and columns would be incredibly slow as well as contain a lot of area which the user may not be interested in. We therefore divide the world up into small chunks that represent the model area. These chunks can be any shape: for example 1 by 1 degree tiles, river catchments, countries, provinces, or some other arbitrary shape. A certain collection of these chunks is called a &#8220;Discretization&#8221;. The following discretizations are created by default:</p>
<table border="1" class="docutils">
<colgroup>
<col width="38%" />
<col width="21%" />
<col width="41%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Name</th>
<th class="head">Resolution</th>
<th class="head">Number of chunks</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>world_onedegree_100m</td>
<td>100m</td>
<td>13901</td>
</tr>
<tr class="row-odd"><td>frankrijk_veldwerkgebied_100m</td>
<td>100m</td>
<td>43</td>
</tr>
<tr class="row-even"><td>nederland_5m</td>
<td>5m</td>
<td>2217</td>
</tr>
<tr class="row-odd"><td>european_catchments_100m</td>
<td>100m</td>
<td>?</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="chunk">
<h3>Chunk<a class="headerlink" href="#chunk" title="Permalink to this headline">¶</a></h3>
<p>A <strong>chunk</strong> is a single modelling unit which must be part of a Discretization (chunkscheme). For example, the world_onedegree_100m discretization contains nearly 14000 chunks dispersed all over the world. When a model run is requested, the system checks which chunks in the desired chunkscheme fall within the requested model run extent. A modelling job (with custom parameters) is then started for each of the individual chunks.</p>
</div>
<div class="section" id="map">
<h3>Map<a class="headerlink" href="#map" title="Permalink to this headline">¶</a></h3>
<p>A <strong>map</strong> is a single ouput (attribute) map created by a model. A map must have:</p>
<ul class="simple">
<li>A timestamp (the time which it is simulating)</li>
<li>A geometry belonging to a specific chunk (representing the geographic location of this map)</li>
<li>An attribute name to identify which environmental attribute it represents (snow depth, erosion, rainfall)</li>
<li>A configuration key which represents the configuration parameters that the model was run with. A different set of parameters will result in a different code, and therefore a different map.</li>
</ul>
</div>
<div class="section" id="model">
<h3>Model<a class="headerlink" href="#model" title="Permalink to this headline">¶</a></h3>
<p>A <strong>model</strong> represents an environmental simulation model. All of the models input parameters, code, reporting information, and metadata, are not strictly part of the schema. They are defined inside the model code and copied to JSON database fields when the model code is updated.</p>
</div>
<div class="section" id="modelconfiguration">
<h3>ModelConfiguration<a class="headerlink" href="#modelconfiguration" title="Permalink to this headline">¶</a></h3>
<p>A <strong>modelconfiguration</strong> represents a single set of configuration parameters for a model. All model configurations are identifiable by a unique <strong>config key</strong>. This config key is a hash of a sorted list of parameters. Therefore, every time a model is run with the same parameter set, the config key should also be the same for all those runs.</p>
</div>
<div class="section" id="job">
<h3>Job<a class="headerlink" href="#job" title="Permalink to this headline">¶</a></h3>
<p>A <strong>job</strong> is created every time a modelling request is received. Imagine a user submits a job to run model X on a particular area. The job is then assigned a unique ID, a model configuration, and a list of chunks that need to be completed for this model run. The job describes the entire modelling job, even though it technically consists of several small chunks, each of which are processed independently by a worker machine. These smaller jobs encapsuled in a large job are called JobChunks.</p>
</div>
<div class="section" id="jobchunk">
<h3>JobChunk<a class="headerlink" href="#jobchunk" title="Permalink to this headline">¶</a></h3>
<p>A <strong>jobchunks</strong> is usually one of many in a particular Job.</p>
</div>
<div class="section" id="user">
<h3>User<a class="headerlink" href="#user" title="Permalink to this headline">¶</a></h3>
<p>A <strong>user</strong> describes a user in the GEMS system. The system also has UserRoles and Role data models, but these are used more internally to define types of users.</p>
</div>
</div>
<div class="section" id="gems-web-application">
<h2>GEMS Web Application<a class="headerlink" href="#gems-web-application" title="Permalink to this headline">¶</a></h2>
<p>The GEMS web application is built using the <a class="reference external" href="http://flask.pocoo.org">Flask Microframework</a>, a lightweight web application framework for Python. Flask uses the concept of Blueprints to separate logical sections of a web application, allowing you to store all the views related to a specific blueprint in its own directory. The following blueprints are used in the GEMS application:</p>
<table border="1" class="docutils">
<colgroup>
<col width="9%" />
<col width="91%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Name</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>admin</td>
<td>The admin blueprint contains the administrator functionality of the website. This includes code for adding new models, discretizations, and viewing the jobs submitted by regular users.</td>
</tr>
<tr class="row-odd"><td>api</td>
<td>The api blueprint handles all the API functionality, such as posting jobs, requesting statuses.</td>
</tr>
<tr class="row-even"><td>data</td>
<td>The data blueprint is a proxy for the mapserver server. It requests map tiles from the backend mapserver, caches the map tiles. Downloading data files will also be implemented in the data blueprint.</td>
</tr>
<tr class="row-odd"><td>install</td>
<td>The install blueprint is only used during the installation of the web application. After the webapp has been installed, trying to navigate to the install blueprint should give an error.</td>
</tr>
<tr class="row-even"><td>modeller</td>
<td>The modeller blueprint is used for serving the javascript application which is the modelling front end of the application. This is where users pan to a certain area, run models, and load output maps in the interactive map.</td>
</tr>
<tr class="row-odd"><td>site</td>
<td>The site blueprint serves the GEMS site itself, such as the login page, &#8216;about this project&#8217; pages, that sort of stuff.</td>
</tr>
<tr class="row-even"><td>status</td>
<td>The status blueprint serves a status page.</td>
</tr>
</tbody>
</table>
<p>The <code class="docutils literal"><span class="pre">templates</span></code> and <code class="docutils literal"><span class="pre">static</span></code> directories do not contain blueprints. The templates directory contains all the templates, with one subdirectory for each of the blueprints described above. The static directory contains all the static content for the web application (images, style sheets, javascripts, etc.)</p>
</div>
<div class="section" id="gems-modeller">
<h2>GEMS Modeller<a class="headerlink" href="#gems-modeller" title="Permalink to this headline">¶</a></h2>
<p>The GEMS modeller is the JavaScript web application which provides the modelling/web mapping interface in which users interact with environmental models. The JavaScript code communicates with the GEMS API to submit jobs, and loads the resulting maps into the web interface using web mapping services (WMS). The main code for the modeller are JavaScripts served as static files through the static directory, but the code for generating this HTML and supplying the JavaScript files with the correct parameters (such as the API key) lives in the &#8220;modeller&#8221; blueprint of the Flask web application.</p>
</div>
<div class="section" id="gems-processing">
<h2>GEMS Processing<a class="headerlink" href="#gems-processing" title="Permalink to this headline">¶</a></h2>
<p>The processing capabilities of GEMS live in the <code class="docutils literal"><span class="pre">processing</span></code> directory of the repository. There is a main processing script <code class="docutils literal"><span class="pre">client.py</span></code> which does a lot of the plumbing surrounding a new model run. When it is started it tests the connection to the API and the work queue with the credentials you&#8217;ve provided. When a job is reserved from the queue, it is loaded into a modified version of the PCRaster-Python modelling framework and processed. The modifications to the PCRaster-Python framework are roughly the following:</p>
<ul class="simple">
<li>The clone map is set dynamically using a bounding box of the chunk and the cellsize of the chunkscheme</li>
<li>Data providers allow you to read in raster data from external sources (rather than having to do this manually and load them using PCRaster&#8217;s readmap)</li>
<li>Data providers allow you to resample this data onto the model grid</li>
<li>Reporting data does not create a PCRaster map file, but instead stores the raster map in memory as a nump array. At the end of the processing, a postprocessing step is added in which all the raster layers reported in this way are aggregated and saved as geotiff files.</li>
<li>The geotiff files are then optimized (overviews added, compression added) and posted to the API using an HTTP POST.</li>
</ul>
</div>
<div class="section" id="an-example-model-run">
<h2>An Example Model Run<a class="headerlink" href="#an-example-model-run" title="Permalink to this headline">¶</a></h2>
<p>The diagram below shows what happens during a typical model run.</p>
<img alt="_images/job_diagram.png" src="_images/job_diagram.png" />
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="webapplication.html" class="btn btn-neutral float-right" title="GEMS Web Application" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="install.html" class="btn btn-neutral" title="Installation" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Department of Physical Geography, Utrecht University..

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>